<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Safety Reports - Splash</title>
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/reports.css" />
    <script defer src="assets/js/navigation.js"></script>
    <script src="assets/js/weather-api.js"></script>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <link rel="alternate icon" href="favicon.ico" />
</head>

<body>
    <div id="navbar"></div>

    <div class="app-container">
        <!-- Main Reports Card -->
        <div class="reports-main-card">
            <!-- Header Section -->
            <div class="reports-header">
                <h2>üåä Community Safety Reports</h2>
                <p class="reports-subtitle">Real-time flood safety updates from the community</p>
                
                <!-- Community Message Card -->
                <div class="community-message-card">
                    <p class="community-message">
                        <span class="message-icon">üíô</span>
                        Help keep our community safe! Please report any flood-related conditions in your area. 
                        Your timely updates help everyone stay informed and prepared. Together, we can navigate 
                        through challenging times and support each other as a community.
                    </p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <div class="stat-number" id="safe-count">0</div>
                        <div class="stat-label">Safe Areas</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-content">
                        <div class="stat-number" id="danger-count">0</div>
                        <div class="stat-label">Danger Areas</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <div class="stat-number" id="total-reports">0</div>
                        <div class="stat-label">Total Reports</div>
                    </div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="status-filter">Status:</label>
                    <select id="status-filter">
                        <option value="all">All Reports</option>
                        <option value="safe">Safe Areas</option>
                        <option value="danger">Danger Areas</option>
                        <option value="investigating">Under Investigation</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="area-filter">Area:</label>
                    <select id="area-filter">
                        <option value="all">All Areas</option>
                        <option value="downtown">Downtown</option>
                        <option value="capitol-hill">Capitol Hill</option>
                        <option value="queen-anne">Queen Anne</option>
                        <option value="waterfront">Waterfront</option>
                        <option value="pioneer-square">Pioneer Square</option>
                        <option value="sodo">SODO</option>
                        <option value="first-hill">First Hill</option>
                        <option value="international-district">International District</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="time-filter">Time:</label>
                    <select id="time-filter">
                        <option value="all">All Time</option>
                        <option value="1h">Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                    </select>
                </div>
                <button id="add-report-btn" class="add-report-btn">üìù Add Report</button>
            </div>

            <!-- Reports List -->
            <div class="reports-container" id="reports-container">
                <div class="loading-message">Loading community reports...</div>
            </div>

            <!-- Enhanced Weather & Community Intelligence -->
            <div class="weather-integration">
                <h3>üå§Ô∏è Intelligent Risk Assessment</h3>
                <div class="weather-summary" id="weather-summary">
                    <div class="weather-item">
                        <span class="weather-label">Temperature:</span>
                        <span class="weather-value" id="current-temp">--¬∞C</span>         
                    </div>
                    <div class="weather-item">
                        <span class="weather-label">Rainfall:</span>
                        <span class="weather-value" id="current-rainfall">--mm</span>
                    </div>
                    <div class="weather-item">
                        <span class="weather-label">Combined Flood Risk:</span>
                        <span class="weather-value" id="flood-risk-level">--</span>
                    </div>
                    <!-- New Community Intelligence Section -->
                    <div class="community-intelligence">
                        <div class="intelligence-item">
                            <span class="intelligence-label">Community Influence:</span>
                            <span class="intelligence-value" id="community-influence">--</span>
                        </div>
                        <div class="intelligence-item">
                            <span class="intelligence-label">Nearby Reports:</span>
                            <span class="intelligence-value" id="nearby-reports-count">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Report Modal -->
    <div id="add-report-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Add Safety Report</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="report-form">
                    <div class="form-group">
                        <label for="report-location">Location:</label>
                        <input type="text" id="report-location" placeholder="Enter location or address" required>
                    </div>
                    <div class="form-group">
                        <label for="report-status">Safety Status:</label>
                        <select id="report-status" required>
                            <option value="">Select status...</option>
                            <option value="safe">‚úÖ Safe</option>
                            <option value="danger">‚ö†Ô∏è Danger</option>
                            <option value="investigating">üîç Under Investigation</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="report-description">Description:</label>
                        <textarea id="report-description" placeholder="Describe the current conditions..." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="report-severity">Severity Level:</label>
                        <select id="report-severity">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel">Cancel</button>
                        <button type="submit" class="btn-submit">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mobile Quick Access FAB -->
    <a href="map.html" class="quick-access-fab" title="Quick Access to Map">üìç<span class="fab-text">Map</span></a>

    <script>
        // Reports data and functionality
        let reportsData = [];
        let filteredReports = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadReports();
            loadWeatherData();
            setupEventListeners();
        });

        // Load reports from localStorage and map data
        function loadReports() {
            // Load from map locations
            fetch('assets/data/locations.json')
                .then(response => response.json())
                .then(mapData => {
                    const mapReports = mapData.map(location => ({
                        id: `map-${location.lat}-${location.lng}`,
                        location: getLocationName(location),
                        area: getAreaFromLocation(location),
                        status: location.point > 0 ? 'safe' : 'danger',
                        severity: getSeverityFromPoint(location.point),
                        description: location.description,
                        timestamp: new Date().toISOString(),
                        source: 'map-data',
                        point: location.point
                    }));

                    // Load user reports from localStorage
                    const userReports = JSON.parse(localStorage.getItem('userReports') || '[]');
                    
                    reportsData = [...mapReports, ...userReports];
                    filteredReports = [...reportsData];
                    renderReports();
                    updateStats();
                })
                .catch(error => {
                    console.error('Error loading reports:', error);
                    renderReports();
                });
        }

        // Load weather data with community intelligence integration
        async function loadWeatherData() {
            try {
                // Initialize WeatherAPI if available
                let weatherAPI = null;
                if (typeof WeatherAPI !== 'undefined') {
                    weatherAPI = new WeatherAPI('NO_API_KEY_NEEDED', 'nws');
                }
                
                let weatherData = null;
                
                // Try to get real-time data first (if weatherAPI available)
                if (weatherAPI) {
                    try {
                        // Default to Seattle coordinates for city overview
                        weatherData = await weatherAPI.getCurrentWeather(47.6062, -122.3321);
                        
                        // Cache the enhanced data
                        localStorage.setItem('realtimeWeatherCache', JSON.stringify({
                            ...weatherData,
                            timestamp: Date.now()
                        }));
                    } catch (apiError) {
                        console.warn('API unavailable, using fallback data:', apiError);
                    }
                }
                
                // Fallback to cached or static data
                if (!weatherData) {
                    const cachedData = localStorage.getItem('realtimeWeatherCache');
                    if (cachedData) {
                        const cache = JSON.parse(cachedData);
                        if (Date.now() - cache.timestamp < 600000) { // 10 minutes
                            weatherData = cache;
                        }
                    }
                    
                    // Final fallback to static data
                    if (!weatherData) {
                        const response = await fetch('assets/data/weather.json');
                        const staticData = await response.json();
                        weatherData = staticData.current;
                    }
                }
                
                // Update weather display
                document.getElementById('current-temp').textContent = `${weatherData.temperature}¬∞C`;
                document.getElementById('current-rainfall').textContent = `${weatherData.rainfall.toFixed(1)}mm`;
                document.getElementById('flood-risk-level').textContent = weatherData.floodRisk || 'Low';
                
                // Update community intelligence
                if (weatherData.userReportInfluence !== undefined) {
                    const influence = weatherData.userReportInfluence;
                    let influenceText = 'Neutral';
                    if (influence > 15) influenceText = 'High Risk ‚¨ÜÔ∏è';
                    else if (influence > 5) influenceText = 'Moderate Risk ‚¨ÜÔ∏è';
                    else if (influence < -5) influenceText = 'Lower Risk ‚¨áÔ∏è';
                    
                    document.getElementById('community-influence').textContent = influenceText;
                } else {
                    document.getElementById('community-influence').textContent = 'Available';
                }
                
                if (weatherData.nearbyReports) {
                    document.getElementById('nearby-reports-count').textContent = weatherData.nearbyReports.length;
                } else {
                    // Count from localStorage reports
                    const recentReports = JSON.parse(localStorage.getItem('userReports') || '[]')
                        .filter(report => {
                            const reportTime = new Date(report.timestamp);
                            const now = new Date();
                            return (now - reportTime) < 24 * 60 * 60 * 1000;
                        });
                    document.getElementById('nearby-reports-count').textContent = recentReports.length;
                }
                
            } catch (error) {
                console.error('Error loading weather data:', error);
                // Fallback show static data
                document.getElementById('current-temp').textContent = '--¬∞C';
                document.getElementById('current-rainfall').textContent = '--mm';
                document.getElementById('flood-risk-level').textContent = 'Unknown';
                document.getElementById('community-influence').textContent = 'Unavailable';
                document.getElementById('nearby-reports-count').textContent = '--';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter controls
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('area-filter').addEventListener('change', applyFilters);
            document.getElementById('time-filter').addEventListener('change', applyFilters);

            // Add report button
            document.getElementById('add-report-btn').addEventListener('click', showAddReportModal);

            // Modal controls
            document.querySelector('.close').addEventListener('click', hideAddReportModal);
            document.querySelector('.btn-cancel').addEventListener('click', hideAddReportModal);
            document.getElementById('report-form').addEventListener('submit', handleReportSubmit);

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('add-report-modal');
                if (event.target === modal) {
                    hideAddReportModal();
                }
            });
        }

        // Apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const areaFilter = document.getElementById('area-filter').value;
            const timeFilter = document.getElementById('time-filter').value;

            filteredReports = reportsData.filter(report => {
                // Status filter
                if (statusFilter !== 'all' && report.status !== statusFilter) {
                    return false;
                }

                // Area filter
                if (areaFilter !== 'all' && report.area !== areaFilter) {
                    return false;
                }

                // Time filter
                if (timeFilter !== 'all') {
                    const reportTime = new Date(report.timestamp);
                    const now = new Date();
                    const timeDiff = now - reportTime;

                    switch (timeFilter) {
                        case '1h':
                            if (timeDiff > 60 * 60 * 1000) return false;
                            break;
                        case '6h':
                            if (timeDiff > 6 * 60 * 60 * 1000) return false;
                            break;
                        case '24h':
                            if (timeDiff > 24 * 60 * 60 * 1000) return false;
                            break;
                        case '7d':
                            if (timeDiff > 7 * 24 * 60 * 60 * 1000) return false;
                            break;
                    }
                }

                return true;
            });

            renderReports();
        }

        // Render reports
        function renderReports() {
            const container = document.getElementById('reports-container');
            
            if (filteredReports.length === 0) {
                container.innerHTML = `
                    <div class="no-reports">
                        <div class="no-reports-icon">üìã</div>
                        <h3>No reports found</h3>
                        <p>Try adjusting your filters or add a new report.</p>
                    </div>
                `;
                return;
            }

            // Sort by timestamp (newest first)
            const sortedReports = filteredReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const reportsHTML = sortedReports.map(report => `
                <div class="report-card ${report.status}">
                    <div class="report-header">
                        <div class="report-location">${report.location}</div>
                        <div class="report-time">${formatTimestamp(report.timestamp)}</div>
                    </div>
                    <div class="report-content">
                        <div class="report-status ${report.status}">
                            ${getStatusIcon(report.status)} ${getStatusText(report.status)}
                        </div>
                        <div class="report-description">${report.description}</div>
                        <div class="report-meta">
                            <span class="report-severity severity-${report.severity}">${report.severity.toUpperCase()}</span>
                            <span class="report-area">üìç ${report.area}</span>
                            ${report.source === 'user' ? '<span class="report-source">üë§ User Report</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = reportsHTML;
        }

        // Update statistics
        function updateStats() {
            const safeCount = reportsData.filter(r => r.status === 'safe').length;
            const dangerCount = reportsData.filter(r => r.status === 'danger').length;
            const totalCount = reportsData.length;

            document.getElementById('safe-count').textContent = safeCount;
            document.getElementById('danger-count').textContent = dangerCount;
            document.getElementById('total-reports').textContent = totalCount;
        }

        // Show add report modal
        function showAddReportModal() {
            document.getElementById('add-report-modal').style.display = 'block';
        }

        // Hide add report modal
        function hideAddReportModal() {
            document.getElementById('add-report-modal').style.display = 'none';
            document.getElementById('report-form').reset();
        }

        // Handle report submission
        function handleReportSubmit(event) {
            event.preventDefault();
            
            const location = document.getElementById('report-location').value;
            const status = document.getElementById('report-status').value;
            const description = document.getElementById('report-description').value;
            const severity = document.getElementById('report-severity').value;

            const newReport = {
                id: `user-${Date.now()}`,
                location: location,
                area: getAreaFromLocationName(location),
                status: status,
                severity: severity,
                description: description,
                timestamp: new Date().toISOString(),
                source: 'user'
            };

            // Add to reports data
            reportsData.unshift(newReport);
            
            // Save to localStorage
            const userReports = JSON.parse(localStorage.getItem('userReports') || '[]');
            userReports.unshift(newReport);
            localStorage.setItem('userReports', JSON.stringify(userReports));

            // Update display
            applyFilters();
            updateStats();
            hideAddReportModal();

            // Show success message
            alert('Report submitted successfully! Thank you for contributing to community safety.');
        }

        // Helper functions
        function getLocationName(location) {
            const areaMap = {
                'downtown': 'Downtown Seattle',
                'capitol-hill': 'Capitol Hill',
                'queen-anne': 'Queen Anne',
                'waterfront': 'Waterfront',
                'pioneer-square': 'Pioneer Square',
                'sodo': 'SODO District',
                'first-hill': 'First Hill',
                'international-district': 'International District'
            };
            return areaMap[getAreaFromLocation(location)] || 'Unknown Area';
        }

        function getAreaFromLocation(location) {
            // Simple mapping based on coordinates
            if (location.lat > 47.62 && location.lng > -122.34) return 'capitol-hill';
            if (location.lat > 47.62 && location.lng < -122.34) return 'queen-anne';
            if (location.lat < 47.61 && location.lng > -122.33) return 'waterfront';
            if (location.lat < 47.61 && location.lng < -122.33) return 'pioneer-square';
            if (location.lat < 47.61) return 'sodo';
            if (location.lat > 47.61 && location.lat < 47.62) return 'first-hill';
            return 'downtown';
        }

        function getAreaFromLocationName(locationName) {
            const name = locationName.toLowerCase();
            if (name.includes('capitol')) return 'capitol-hill';
            if (name.includes('queen')) return 'queen-anne';
            if (name.includes('waterfront')) return 'waterfront';
            if (name.includes('pioneer')) return 'pioneer-square';
            if (name.includes('sodo')) return 'sodo';
            if (name.includes('first hill')) return 'first-hill';
            if (name.includes('international')) return 'international-district';
            return 'downtown';
        }

        function getSeverityFromPoint(point) {
            const absPoint = Math.abs(point);
            if (absPoint >= 8) return 'high';
            if (absPoint >= 5) return 'medium';
            return 'low';
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'safe': return '‚úÖ';
                case 'danger': return '‚ö†Ô∏è';
                case 'investigating': return 'üîç';
                default: return '‚ùì';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'safe': return 'Safe';
                case 'danger': return 'Danger';
                case 'investigating': return 'Under Investigation';
                default: return 'Unknown';
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60 * 1000) return 'Just now';
            if (diff < 60 * 60 * 1000) return `${Math.floor(diff / (60 * 1000))}m ago`;
            if (diff < 24 * 60 * 60 * 1000) return `${Math.floor(diff / (60 * 60 * 1000))}h ago`;
            return date.toLocaleDateString();
        }
    </script>
</body>

</html>